<html>
  <head>
    <title>EDS API experiment</title>

    <!-- Vue. Note: vue-spinners says to put things in this order. -->

    <link rel="stylesheet" href="https://unpkg.com/vue-spinners/dist/vue-spinners.css">
    <script type="text/javascript" src="https://unpkg.com/vue"></script>
    <script type="text/javascript" src="https://unpkg.com/vue-spinners"></script>

    <!-- Load general JavaScript dependencies. -->

    <script type="text/javascript" src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script type="text/javascript" src="https://unpkg.com/loglevel"></script>
    <script type="text/javascript" src="https://unpkg.com/loglevel-plugin-prefix"></script>
    <script type="text/javascript" src="https://unpkg.com/he"></script>
    <script type="text/javascript" src="https://unpkg.com/humanize-plus"></script>

    <!-- Our app. -->

    <!-- Next line is to make syntax here and in node -->
    <script type="text/javascript">module = {}</script>
    <script type="text/javascript" src="app-settings.js"></script>
    <script type="text/javascript" src="lib/log.js"></script>
    <script type="text/javascript" src="lib/net.js"></script>
    <script type="text/javascript" src="lib/string.js"></script>

    <link rel="stylesheet" href="app.css"></script>
  </head>
  <body>
    <div id="app">
      <input v-model="searchString" v-on:keyup.enter="run"
             class="search-input" type="text" placeholder="Search string">

      <button v-on:click="run" class="search-button">Search</button>

      <modal v-if="errorEmptyString" v-on:close="errorEmptyString = false">
        <span slot="header">Error</span>
        <span slot="body">Cannot search for an empty string.</span>
      </modal>

      <div class="output">
        <span class="search-status">
          {{ searchStatus }}<circ v-if="isSearching"></circ>
        </span>
        <span class="num-results">{{ numResults }}</span>
        <div class="results-table">
          <ul class="results-list">
            <li v-for="record in records">
              <div class="pub-record">
                <div class="pub-title">   <span v-html="filterEDStitle(record.Items[0].Data)"></span></div>
                <div class="pub-authors"> <span v-html="filterEDSauthors(record.Items[1].Data)"></span></div>
                <div class="pub-source">  <span v-html="filterEDSsource(record.Items[2].Data)"></span></div>
              </div>
            </li>
          </ul>
        </div>
      </div>

    </div>
    <script>

     // Global configuration.
     // .......................................................................

     // Set the logging level.  Use 'trace' for debugging, 'warn' for normal.
     log.setDefaultLevel('trace');

     // How long to wait on axios http post, in milliseconds.
     const postTimeout = 5 * 1000;


     // Main code.
     // .......................................................................

     Vue.component('circ', VueSpinners.CircleSpinner);

     Vue.component("modal", {
       template: `
      <transition name="modal">
        <div class="modal-mask">
          <div class="modal-wrapper">
            <div class="modal-container">
              <div class="modal-header"><slot name="header"></slot></div>
              <div class="modal-body"><slot name="body"></slot></div>
              <div class="modal-footer">
                <button id="ok-button" class="modal-default-button"
                  v-on:click="$emit('close')" v-on:keydown.esc="$emit('close')">
                  OK
                </button>
              </div>
            </div>
          </div>
        </div>
      </transition>`,
       mounted: function() {
         // Put focus on the button by default.
         document.getElementById("ok-button").focus();
       }
     });

     // Define our Vue application.
     new Vue({
       el: '#app',
       data: {
         errorEmptyString: false,
         searchString: '',
         searchStatus: '',
         numResults: '',
         records: [],
         isSearching: false,
       },
       methods: {

         // Helper functions.
         // ...................................................................

         authToken() {
           let body = JSON.stringify({ "UserId": config.user,
                                       "Password": config.password });
           log.debug('getting authentication token');
           return net.post(config.authURL, config.corsproxy, body)
                     .then(data => data.AuthToken);
         },

         sessionToken(a_token) {
           log.debug('getting session token');
           return net.post(config.sessionURL, config.corsproxy,
                           {'Profile': 'edsapi'},
                           {'x-authenticationToken': a_token })
                     .then(data => data.SessionToken);
         },

         searchResults(a_token, s_token) {
           let headers = {'x-authenticationToken': a_token,
                          'x-sessionToken': s_token,
                          'Content-Type': 'application/json' };
           let body = {
             "SearchCriteria": {
               "Queries":[ { "Term": this.searchString } ],
               "SearchMode": "all",
               "IncludeFacets": "y",
               "Sort": "relevance",
               "AutoSuggest": "n",
               "AutoCorrect": "n"
             },
             "RetrievalCriteria": {
               "View": "brief",
               "ResultsPerPage": 20,
               "PageNumber": 1,
               "Highlight": "y",
               "IncludeImageQuickView": "n"
             },
             "Actions": null
           };
           log.debug('sending search query');
           return net.post(config.searchURL, config.corsproxy, body, headers)
                     .then(data => data.SearchResult);
         },

         filterEDStitle(str) {
           let htmlified = he.decode(str);  // Replace quoted HTML entities.
           htmlified = htmlified.replaceAll(/<highlight>/i, '<span class="highlight">');
           htmlified = htmlified.replaceAll(/<\/highlight>/i, '</span>');
           return htmlified;
         },

         filterEDSauthors(str) {
           let htmlified = he.decode(str);  // Replace quoted HTML entities.
           htmlified = htmlified.replaceAll(/<searchlink.*?>(.+?)<\/searchlink>/i,
                                            '<span class="author">$1</span>');
           htmlified = htmlified.replaceAll(/<relatesto.*?>(.+?)<\/relatesto><i>(.+?)<\/i>/i,
                                            '');
           htmlified = htmlified.replace(/<br ?\/?>/gi, ' ');
           return htmlified;
         },

         filterEDSsource(str) {
           let htmlified = he.decode(str);  // Replace quoted HTML entities.
           return htmlified;
         },


         // Main body.
         // ...................................................................

         run() {
           // Sanity checks.

           if (! this.searchString) {
             log.debug('empty search string');
             this.errorEmptyString = true;
             return false;
           }

           // Set up state for a new search.

           log.debug('clearing state and starting a search')
           this.records = [];
           this.numResults = '';
           this.searchStatus = 'Searching for "' + this.searchString + '" ...';
           this.isSearching = true;

           // Let's do this thing.

           let authTokenPromise = this.authToken();

           let sessionTokenPromise = authTokenPromise.then(
             (atok) => {
               return this.sessionToken(atok);
             });

           let searchPromise = Promise.all([authTokenPromise, sessionTokenPromise]).then(
             (tokens) => {
               return this.searchResults(tokens[0], tokens[1]);
             });

           let items = searchPromise.then(
             (results) => {
               log.debug('results received');
               this.isSearching = false;
               this.searchStatus = 'Searching for "' + this.searchString + '" ... Done.';
               console.log(results);
               stats = results.Statistics;
               this.numResults = 'Total number of hits: '
                               + Humanize.intComma(stats.TotalHits) + '.';
               this.records = results.Data.Records;
               console.log(this.numResults);
             });
         },
       }
     })
    </script>
  </body>
</html>
