<html>
  <head>
    <title>Test</title>
    <link rel="stylesheet" href="https://unpkg.com/vue-spinners/dist/vue-spinners.css">
    <script type="text/javascript" src="https://unpkg.com/vue"></script>
    <script type="text/javascript" src="https://unpkg.com/vue-spinners/dist/vue-spinners.browser.js"></script>
    <script type="text/javascript" src="https://unpkg.com/loglevel"></script>
    <script type="text/javascript" src="https://unpkg.com/he"></script>
    <script type="text/javascript" src="https://unpkg.com/humanize-plus"></script>
    <script type="text/javascript" src="https://unpkg.com/loglevel-plugin-prefix"></script>
    <script type="text/javascript" src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <!-- Next line is to make syntax of config.js work for here and in node -->
    <script type="text/javascript">module = {}</script>
    <script type="text/javascript" src="./config.js"></script>
    <script type="text/javascript" src="./net.js"></script>
    <script type="text/javascript" src="./string.js"></script>
    <script type="text/x-template" id="modal-template">
      <transition name="modal">
        <div class="modal-mask">
          <div class="modal-wrapper">
            <div class="modal-container">
              <div class="modal-header">
                <slot name="header">Error</slot>
              </div>
              <div class="modal-body">
                <slot name="body">
                  An empty search string will not work.
                </slot>
              </div>
              <div class="modal-footer">
                <slot name="footer">
                  <button class="modal-default-button" @click="$emit('close')">
                    OK
                  </button>
                </slot>
              </div>
            </div>
          </div>
        </div>
      </transition>
    </script>
    <style>
     .search-input {
       margin: 2em auto; 
       display: block;
       border: 1px sold gray;
       width: 75%;
     }

     .search-button {
       display: block;
       margin: 2em auto;
     }

     .output {
       display: block;
       margin: 2em auto;
       width: 80%;
     }

     .modal-mask {
       position: fixed;
       z-index: 9998;
       top: 0;
       left: 0;
       width: 100%;
       height: 100%;
       background-color: rgba(0, 0, 0, 0.5);
       display: table;
       transition: opacity 0.3s ease;
     }

     .modal-wrapper {
       display: table-cell;
       vertical-align: middle;
     }

     .modal-container {
       width: 300px;
       margin: 0px auto;
       padding: 20px 30px;
       background-color: #fff;
       display: block;
       border: 1px solid #dedede;
       border-radius: 0.5em;
       box-shadow: 0 2px 8px rgba(0, 0, 0, 0.33);
       transition: all 0.3s ease;
       font-family: Helvetica, Arial, sans-serif;
     }

     .modal-header {
       font-weight: bold;
       margin-top: 0;
       color: #992244;
       text-align: center;
     }

     .modal-body {
       margin: 20px 0;
     }

     .modal-footer {
       padding-bottom: 1em;
     }

     .modal-default-button {
       float: right;
     }

     /*
      * The following styles are auto-applied to elements with
      * transition="modal" when their visibility is toggled
      * by Vue.js.
      *
      * You can easily play with the modal transition by editing
      * these styles.
      */

     .modal-enter {
       opacity: 0;
     }

     .modal-leave-active {
       opacity: 0;
     }

     .modal-enter .modal-container,
     .modal-leave-active .modal-container {
       -webkit-transform: scale(1.1);
       transform: scale(1.1);
     }

     .pub-record {
       display: block;
       margin: 1em;
     }

     .pub-title {
       display: block;
       font-weight: bold;
       margin-bottom: 0.25em;
     }

     .pub-authors {
       display: block;
       margin-bottom: 0.25em;
     }

     .pub-source {
       display: block;
       font-style: italic;
     }
     
     .highlight {
       background-color: #ffffcc;
     }

     .author {
       display: inline-block;
       border: 1px solid #ddd;
       border-radius: 4px;
       padding: 1px;
       margin-right: 0.25em;
     }
     
     .search-status {
       display: block;
     }

     .results-list {
       padding-left: 1em;
     }
    </style>
  </head>
  <body>
    <div id="app">
      <input v-model="searchString" v-on:keyup.enter="run"
             class="search-input" type="text" placeholder="Search string">
      <button v-on:click="run" class="search-button">Search</button>
      <div class="output">
        <span class="search-status">{{ searchStatus }}<circ v-if="isSearching"></circ></span>
        <span class="num-results">{{ numResults }}</span>
        <div class="results-table">
          <ul class="results-list">
            <li v-for="record in records">
              <div class="pub-record">
                <div class="pub-title">   <span v-html="filterEDStitle(record.Items[0].Data)"></span></div>
                <div class="pub-authors"> <span v-html="filterEDSauthors(record.Items[1].Data)"></span></div>
                <div class="pub-source">  <span v-html="filterEDSsource(record.Items[2].Data)"></span></div>
              </div>
            </li>
          </ul>
        </div>
      </div>
      <modal v-if="showEmptyStringModal" @close="showEmptyStringModal = false">
    </div>
    <script>
     // Global configuration.
     // .......................................................................

     // Set the logging level.  Use 'trace' for debugging, 'warn' for normal.
     log.setDefaultLevel('trace');

     // How long to wait on axios http post, in milliseconds.
     const postTimeout = 5 * 1000;


     // Main code.
     // .......................................................................

     // Prefix log messages.
     var log = log.noConflict();
     var prefixer = prefix.noConflict();
     prefixer.reg(log);
     prefixer.apply(log);

     // Register modal component.
     Vue.component("modal", {
       template: "#modal-template"
     });

     Vue.component('circ', VueSpinners.CircleSpinner);

     // Define our Vue application.
     new Vue({
       el: '#app',
       data: {
         showEmptyStringModal: false,
         searchString: '',
         searchStatus: '',
         numResults: '',
         records: '',
         isSearching: false,
       },
       methods: {

         // Helper functions.
         // ...................................................................

         authToken() {
           let body = JSON.stringify({ "UserId": config.user,
                                       "Password": config.password });
           return net.post(config.authURL, config.corsproxy, body)
                     .then(data => data.AuthToken);
         },

         sessionToken(a_token) {
           return net.post(config.sessionURL, config.corsproxy,
                           {'Profile': 'edsapi'},
                           {'x-authenticationToken': a_token })
                     .then(data => data.SessionToken);
         },

         searchResults(a_token, s_token) {
           let headers = {'x-authenticationToken': a_token,
                          'x-sessionToken': s_token,
                          'Content-Type': 'application/json' };
           let body = {
             "SearchCriteria": {
               "Queries":[ { "Term": this.searchString } ],
               "SearchMode": "all",
               "IncludeFacets": "y",
               "Sort": "relevance",
               "AutoSuggest": "n",
               "AutoCorrect": "n"
             },
             "RetrievalCriteria": {
               "View": "brief",
               "ResultsPerPage": 20,
               "PageNumber": 1,
               "Highlight": "y",
               "IncludeImageQuickView": "n"
             },
             "Actions": null
           };
           return net.post(config.searchURL, config.corsproxy, body, headers)
                     .then(data => data.SearchResult);
         },

         filterEDStitle(str) {
           let htmlified = he.decode(str);  // Replace quoted HTML entities.
           htmlified = htmlified.replaceAll(/<highlight>/i, '<span class="highlight">');
           htmlified = htmlified.replaceAll(/<\/highlight>/i, '</span>');
           return htmlified;
         },

         filterEDSauthors(str) {
           let htmlified = he.decode(str);  // Replace quoted HTML entities.
           htmlified = htmlified.replaceAll(/<searchlink.*?>(.+?)<\/searchlink>/i,
                                            '<span class="author">$1</span>');
           htmlified = htmlified.replaceAll(/<relatesto.*?>(.+?)<\/relatesto><i>(.+?)<\/i>/i,
                                            '');
           htmlified = htmlified.replace(/<br ?\/?>/gi, ' ');
           return htmlified;
         },

         filterEDSsource(str) {
           let htmlified = he.decode(str);  // Replace quoted HTML entities.
           return htmlified;
         },


         // Main body.
         // ...................................................................

         run() {
           // Sanity checks
           // .................................................................

           if (! this.searchString) {
             this.showEmptyStringModal = true;
             return false;
           }

           this.searchStatus = 'Searching for "' + this.searchString + '" ...';
           this.isSearching = true;

           let authTokenPromise = this.authToken();

           let sessionTokenPromise = authTokenPromise.then(
             (atok) => {
               return this.sessionToken(atok);
             });

           let searchPromise = Promise.all([authTokenPromise, sessionTokenPromise]).then(
             (tokens) => {
               return this.searchResults(tokens[0], tokens[1]);
             });

           let items = searchPromise.then(
             (results) => {
               this.isSearching = false;
               this.searchStatus = 'Searching for "' + this.searchString + '" ... Done.';
               console.log(results);
               stats = results.Statistics;
               this.numResults = 'Total number of hits: '
                               + Humanize.intComma(stats.TotalHits) + '.';
               this.records = results.Data.Records;
               console.log(this.numResults);
             });
         },
       }
     })
    </script>
  </body>
</html>
